[source: 212] <!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FalakZoom - Enhanced</title> {/* Updated Title */}
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        margin: 0;
[source: 213] overflow: hidden;
        background: black;
        font-family: "Poppins", "Cairo", Arial, sans-serif; /* Added Cairo */
      }

      /* Updated infoPanel position */
      #infoPanel {
        position: absolute;
[source: 214] top: 70px;
        left: 20px;
        background: rgba(0, 0, 0, 0.85); /* Slightly more opaque */
        color: white;
[source: 215] padding: 20px; /* Increased padding */
        border-radius: 10px;
[source: 216] /* Smoother radius */
        border: 1px solid rgba(255, 255, 255, 0.4);
[source: 217] /* Subtler border */
        display: none;
        max-width: 380px;
[source: 218] /* Slightly wider */
        font-size: 14px;
        line-height: 1.7;
[source: 219] /* Increased line height */
        z-index: 50;
[source: 220] box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4); /* Added shadow */
      }

      /* Updated styles for better readability */
      #infoPanel h2 {
          margin-top: 0;
[source: 221] margin-bottom: 15px;
          font-size: 18px;
          font-weight: 600;
          border-bottom: 1px solid rgba(255, 255, 255, 0.3);
          padding-bottom: 8px;
[source: 222] }

      #infoPanel p {
          margin-bottom: 10px;
[source: 223] }

       #infoPanel .fact {
           font-style: italic;
[source: 224] color: #cccccc; /* Lighter color for facts */
           margin-top: 15px;
[source: 225] padding-top: 10px;
           border-top: 1px dashed rgba(255, 255, 255, 0.2);
       }


      #closeBtn {
        position: absolute;
[source: 226] top: 10px;
        left: 10px; /* Changed to left for LTR consistency */
        width: 28px;
[source: 227] /* Adjusted size */
        height: 28px;
[source: 228] /* Adjusted size */
        font-size: 16px;
        font-weight: bold;
        color: #ff6b6b;
[source: 229] /* Softer red */
        cursor: pointer;
[source: 230] transition: transform 0.3s ease, color 0.3s ease,
          background 0.3s ease;
[source: 231] padding: 0;
        background: rgba(255, 255, 255, 0.1); /* Slight background */
        border: none;
[source: 232] border-radius: 50%; /* Circular */
        display: flex;
        justify-content: center;
        align-items: center;
[source: 233] }

      #closeBtn:hover {
        color: #ff4757;
        transform: scale(1.1) rotate(90deg);
[source: 234] /* Added rotation */
        background: rgba(255, 255, 255, 0.2);
[source: 235] }

      /* Menu Bar Styles */
      #menuBar {
        position: absolute;
[source: 236] top: 0;
        left: 0;
        width: 100%;
        height: 50px;
        background: rgba(0, 0, 0, 0.8);
[source: 237] /* Slightly more opaque */
        padding: 0 20px;
[source: 238] /* Adjusted padding */
        box-sizing: border-box;
        display: flex;
        justify-content: space-between;
        align-items: center;
[source: 239] z-index: 100;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }

      .menu-controls {
          display: flex;
[source: 240] /* Group menu items */
          align-items: center;
[source: 241] }

      .menu-item, #langToggleBtn /* Apply same style to lang button */ {
        position: relative;
[source: 242] color: white;
        padding: 8px 15px;
        margin-left: 10px; /* Spacing between items */
        cursor: pointer;
[source: 243] font-family: "Poppins", "Cairo", sans-serif;
        border-radius: 4px;
        transition: background 0.3s ease, color 0.3s ease;
        font-size: 14px;
        user-select: none;
[source: 244] /* Prevent text selection */
      }

      .menu-item:hover, #langToggleBtn:hover {
        background: rgba(255, 255, 255, 0.2);
[source: 245] color: #eee;
      }

      .dropdown {
        position: absolute;
[source: 246] top: 100%;
        right: 0; /* Align dropdown to the right */
        background: rgba(25, 25, 25, 0.95);
[source: 247] /* Darker dropdown */
        min-width: 180px;
[source: 248] /* Adjusted width */
        border-radius: 0 0 6px 6px;
[source: 249] /* Rounded bottom corners */
        overflow: hidden;
        display: none;
[source: 250] box-shadow: 0 8px 16px rgba(0, 0, 0, 0.6); /* Stronger shadow */
        border: 1px solid rgba(255, 255, 255, 0.1);
[source: 251] border-top: none;
        z-index: 110; /* Ensure dropdown is above info panel */
      }

      .dropdown.show {
        display: block;
[source: 252] }

      .dropdown-item {
        padding: 12px 20px;
[source: 253] /* Increased padding */
        color: #e0e0e0;
[source: 254] /* Lighter text */
        text-decoration: none;
        display: block;
[source: 255] transition: background 0.2s ease, color 0.2s ease;
        font-size: 14px;
        white-space: nowrap;
[source: 256] /* Prevent wrapping */
      }

      .dropdown-item:hover {
        background: rgba(255, 255, 255, 0.15);
[source: 257] color: white;
      }

      #title {
        color: white;
[source: 258] font-family: "Poppins", sans-serif;
        font-size: 22px; /* Slightly smaller */
        font-weight: 600;
[source: 259] }

       /* Adjust infoPanel position based on language */
       body[dir="rtl"] #infoPanel {
            left: auto;
[source: 260] right: 20px;
            text-align: right;
       }
       body[dir="ltr"] #infoPanel {
            left: 20px;
[source: 261] right: auto;
            text-align: left;
       }
        /* Adjust close button position based on language */
       body[dir="rtl"] #closeBtn {
            left: 10px;
[source: 262] right: auto;
       }
       body[dir="ltr"] #closeBtn {
            left: auto;
[source: 263] right: 10px; /* Position right for LTR */
       }

    </style>
  </head>
  <body dir="rtl"> <div id="menuBar">
      <div id="title">FalakZoom</div>
      <div class="menu-controls"> <div id="langToggleBtn">English</div> <div class="menu-item" id="planetsMenu">
          الكواكب
          <div class="dropdown" id="planetsDropdown">
            </div>
        </div>
      </div>
    </div>

    
[source: 264] <div id="infoPanel">
      <span id="closeBtn">X</span>
      <h2 id="planetName"></h2>
      <p id="planetInfo"></p>
      <p id="planetFact" class="fact"></p> </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three/examples/js/controls/OrbitControls.js"></script>
    <script>
      // --- Language and UI Text ---
      let currentLanguage = 'ar';
[source: 265] // Default language ('ar' or 'en')

      const uiText = {
          planetsMenu: { ar: "الكواكب", en: "Planets" },
          langToggle: { ar: "English", en: "العربية" },
          // Add other UI elements if needed
      };
[source: 266] // --- Planet Data with Multilingual Support ---
      // ADD '_high.jpg' texture names if you have high-res versions
      const planetsData = [
        {
          id: 0,
          name: { ar: "الشمس", en: "Sun" },
          radius: 5, distance: 0, speed: 0, tilt: 0, rotation: 0.01,
          texture: "sun.jpg",
          // texture_high: "sun_high.jpg", // Example if you have one
          info: {
  
[source: 267]           ar: "القطر: 1.391 مليون كيلومتر\nالكتلة: 1.989 × 10³⁰ كيلوغرام\nالعمر: 4.6 مليار سنة\nالنوع: نجم من النوع G\nدرجة حرارة النواة: 15 مليون درجة مئوية",
            en: "Diameter: 1.391 million km\nMass: 1.989 × 10³⁰ kg\nAge: 4.6 billion years\nType: G-type main-sequence star\nCore Temperature: 15 million °C",
          },
          fact: {
            ar: "الشمس تحتوي على 99.86% من كتلة النظام الشمسي وهي مصدر الطاقة الرئيسي للحياة على الأرض."[cite: 268],
            en: "The Sun contains 99.86% of the Solar System's mass and is the primary source of energy for life on Earth."[cite: 268],
          }
        },
        {
          id: 1,
          name: { ar: "عطارد", en: "Mercury" },
[source: 269]     radius: 0.5, distance: 10, speed: 0.0125, tilt: 0.034, rotation: 0.003,
          texture: "mercury.jpg",
          // texture_high: "mercury_high.jpg",
          info: {
            ar: "القطر: 4,879 كيلومتر\nالكتلة: 3.3 × 10²³ كيلوغرام\nالمدار: 88 يومًا\nدرجة حرارة السطح: من -173°م إلى 427°م\nلا يوجد غلاف جوي تقريبًا",
            en: "Diameter: 4,879 km\nMass: 3.3 × 10²³ kg\nOrbit: 88 days\nSurface Temp: -173°C to 427°C\nAlmost no atmosphere",
       
[source: 270]    },
          fact: {
             ar: "يوم واحد على عطارد (دورة شمسية) يستغرق حوالي 176 يومًا أرضيًا بسبب دورانه البطيء ومداره السريع.",
             en: "One solar day on Mercury lasts about 176 Earth days due to its slow rotation and fast orbit." [cite: 271]
          }
        },
        {
          id: 2,
          name: { ar: "الزهرة", en: "Venus" },
          radius: 0.8, distance: 15, speed: 0.004375, tilt: 177.4, rotation: 0.0004,
          texture: "venus.jpg",
          // texture_high: "venus_high.jpg",
          info: {
            ar: "القطر: 12,104 كيلومتر\nالكتلة: 4.87 × 10²⁴ كيلوغرام\nالمدار: 225 يومًا\nدرجة حرارة السطح: 464°م\nغلاف جوي كثيف من ثاني أكسيد الكربون"[cite: 272],
            en: "Diameter: 12,104 km\nMass: 4.87 × 10²⁴ kg\nOrbit: 225 days\nSurface Temp: 464°C\nThick CO2 atmosphere",
          },
          fact: {
              ar: "الزهرة هي أسخن كواكب المجموعة الشمسية وتدور بعكس اتجاه دوران معظم الكواكب الأخرى (حركة تراجعية).",
           
[source: 273]    en: "Venus is the hottest planet and rotates backwards compared to most other planets (retrograde rotation)." [cite: 273]
          }
        },
        {
          id: 3,
          name: { ar: "الأرض", en: "Earth" },
          radius: 1, distance: 20, speed: 0.003125, tilt: 23.5, rotation: 0.05,
          texture: "earth.jpg",
          texture_high: "earth_high.jpg", // Assuming you have this
          info: {
            ar: "القطر: 12,742 كيلومتر\nالكتلة: 5.97 × 10²⁴ كيلوغرام\nالمدار: 365.25 يومًا\nدرجة حرارة السطح: من -88°م إلى 58°م\nمغطاة بنسبة 71% بالمياه"[cite: 275],
            en: "Diameter: 12,742 km\nMass: 5.97 × 10²⁴ kg\nOrbit: 365.25 days\nSurface Temp: -88°C to 58°C\n71% covered by water",
          },
           fact: {
               ar: "الأرض هي الكوكب الوحيد المعروف حاليًا بوجود حياة ومياه سائلة على سطحه.",
         
[source: 276]       en: "Earth is the only known planet to host life and have liquid water on its surface." [cite: 276]
          }
        },
        {
          id: 4,
          name: { ar: "المريخ", en: "Mars" },
          radius: 0.7, distance: 25, speed: 0.0025, tilt: 25.2, rotation: 0.048,
          texture: "mars.jpg",
          // texture_high: "mars_high.jpg",
          info: {
            ar: "القطر: 6,792 كيلومتر\nالكتلة: 6.42 × 10²³ كيلوغرام\nالمدار: 687 يومًا\nدرجة حرارة السطح: من -153°م إلى 20°م\nغلاف جوي رقيق من ثاني أكسيد الكربون"[cite: 278],
            en: "Diameter: 6,792 km\nMass: 6.42 × 10²³ kg\nOrbit: 687 days\nSurface Temp: -153°C to 20°C\nThin CO2 atmosphere",
          },
          fact: {
              ar: "يُعرف المريخ بالكوكب الأحمر بسبب أكسيد الحديد (الصدأ) على سطحه، ولديه أعلى بركان وأكبر وادي في النظام الشمسي.",
   
[source: 279]            en: "Mars is known as the Red Planet due to iron oxide (rust) on its surface and has the tallest volcano and largest canyon in the Solar System." [cite: 279]
          }
        },
        {
          id: 5,
          name: { ar: "المشتري", en: "Jupiter" },
          radius: 2.5, distance: 35, speed: 0.00125, tilt: 3.1, rotation: 0.1,
          texture: "jupiter.jpg",
          // texture_high: "jupiter_high.jpg",
          info: {
            ar: "القطر: 139,820 كيلومتر\nالكتلة: 1.898 × 10²⁷ كيلوغرام\nالمدار: 11.86 سنة\nدرجة حرارة السطح (قمم السحب): -145°م\nعملاق غازي"[cite: 281],
            en: "Diameter: 139,820 km\nMass: 1.898 × 10²⁷ kg\nOrbit: 11.86 years\nCloud Top Temp: -145°C\nGas giant",
          },
          fact: {
              ar: "المشتري هو أكبر كواكب المجموعة الشمسية وبه البقعة الحمراء العظيمة، وهي عاصفة ضخمة مستمرة منذ قرون.",
             
[source: 282]  en: "Jupiter is the largest planet and features the Great Red Spot, a giant storm raging for centuries." [cite: 282]
          }
        },
        {
          id: 6,
          name: { ar: "زحل", en: "Saturn" },
          radius: 2, distance: 45, speed: 0.0009375, tilt: 26.7, rotation: 0.09,
          texture: "saturn.jpg",
          // texture_high: "saturn_high.jpg",
          info: {
            ar: "القطر: 116,460 كيلومتر\nالكتلة: 5.68 × 10²⁶ كيلوغرام\nالمدار: 29.46 سنة\nدرجة حرارة السطح (قمم السحب): -184°م\nعملاق غازي"[cite: 284],
            en: "Diameter: 116,460 km\nMass: 5.68 × 10²⁶ kg\nOrbit: 29.46 years\nCloud Top Temp: -184°C\nGas giant",
          },
          fact: {
              ar: "يشتهر زحل بنظام حلقاته المذهل المكون أساسًا من جسيمات الجليد والصخور.",
              en: "Saturn is famous for its stunning ring system, made mostly of ice particles and rock debris." [cite: 285]
          }
        },
        {
          id: 7,
          name: { ar: "أورانوس", en: "Uranus" },
          radius: 1.5, distance: 55, speed: 0.0005, tilt: 97.8, rotation: 0.06,
          texture: "uranus.jpg",
          // texture_high: "uranus_high.jpg",
          info: {
            ar: "القطر: 50,724 كيلومتر\nالكتلة: 8.68 × 10²⁵ كيلوغرام\nالمدار: 84 سنة\nدرجة حرارة السطح (قمم السحب): -224°م\nعملاق جليدي"[cite: 287],
            en: "Diameter: 50,724 km\nMass: 8.68 × 10²⁵ kg\nOrbit: 84 years\nCloud Top Temp: -224°C\nIce giant",
          },
          fact: {
              ar: "يدور أورانوس على جانبه بميل محوري يقارب 98 درجة، مما يجعله فريدًا بين الكواكب.",
              en: "Uranus rotates on its side with an axial tilt of nearly 98 degrees, making it unique among planets." [cite: 288]
          }
        },
        {
          id: 8,
          name: { ar: "نبتون", en: "Neptune" },
          radius: 1.5, distance: 65, speed: 0.000375, tilt: 28.3, rotation: 0.07,
          texture: "neptune.jpg",
          // texture_high: "neptune_high.jpg",
          info: {
            ar: "القطر: 49,244 كيلومتر\nالكتلة: 1.02 × 10²⁶ كيلوغرام\nالمدار: 164.8 سنة\nدرجة حرارة السطح (قمم السحب): -201°م\nعملاق جليدي"[cite: 290],
            en: "Diameter: 49,244 km\nMass: 1.02 × 10²⁶ kg\nOrbit: 164.8 years\nCloud Top Temp: -201°C\nIce giant",
          },
          fact: {
              ar: "نبتون هو أبعد كوكب عن الشمس ويتميز بلونه الأزرق العميق ورياحه الأسرع في النظام الشمسي.",
              
[source: 291] en: "Neptune is the farthest planet from the Sun, known for its deep blue color and the fastest winds in the Solar System." [cite: 291]
          }
        },
      ];
[source: 293] // --- THREE.js Setup ---
      const scene = new THREE.Scene();
[source: 294] const camera = new THREE.PerspectiveCamera(
        75,
        window.innerWidth / window.innerHeight,
        0.1,
        2000
      );
[source: 295] camera.position.set(0, 50, 100);
      const renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      const controls = new THREE.OrbitControls(camera, renderer.domElement);
[source: 296] controls.maxDistance = 400;
      controls.minDistance = 0.5; // *** ALLOW CLOSER ZOOM ***
[source: 297] controls.enableDamping = true;
      controls.dampingFactor = 0.05;

      let focusedPlanetIndex = -1;
[source: 298] let isFollowingPlanet = false;
      let followAnimationId = null; // To cancel camera animation if needed
      let lastManualControlTime = 0; // Track user interaction
      const manualControlTimeout = 500; // ms - Time before auto-follow resumes if stopped by interaction

      // *** NEW: Texture Cache for High-Res Textures ***
      const textureCache = {};
      const highResDistanceThreshold = 3; // Switch to high-res if distance < (planetRadius * this_value)

      // Stop following temporarily if user interacts
      controls.addEventListener("start", () => {
        if (isFollowingPlanet) {
             lastManualControlTime = Date.now();
             isFollowingPlanet = false; // Temporarily disable following
             if (followAnimationId) cancelAnimationFrame(followAnimationId);
        }
      });

      // Optional: Resume following if idle after interaction
      controls.addEventListener("end", () => {
          if (focusedPlanetIndex !== -1 && !isFollowingPlanet && (Date.now() - lastManualControlTime > manualControlTimeout)) {
             // Potentially restart following smoothly, or just leave it manual until next selection
             // For simplicity, we'll let the user re-select or click planet to re-enable follow
             console.log("User stopped interaction. Select planet again to follow.");
          }
      });

[source: 299] // Advanced Lighting
      const sunLight = new THREE.PointLight(0xffffff, 1.5, 1500);
[source: 300] sunLight.position.set(0, 0, 0);
      scene.add(sunLight);
      const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
[source: 301] scene.add(ambientLight);
      const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.3);
      hemiLight.position.set(0, 100, 0);
[source: 302] scene.add(hemiLight);

      // Texture Loader
      const loader = new THREE.TextureLoader();
[source: 303] // Starry Background
      const starGeometry = new THREE.BufferGeometry();
      const starCount = 7000;
[source: 304] const positions = new Float32Array(starCount * 3);
[source: 305] for (let i = 0; i < starCount; i++) {
        positions[i * 3] = (Math.random() - 0.5) * 2500;
[source: 306] positions[i * 3 + 1] = (Math.random() - 0.5) * 2500;
[source: 307] positions[i * 3 + 2] = (Math.random() - 0.5) * 2500;
[source: 308] }
      starGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
      const starMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 0.15 });
[source: 309] const stars = new THREE.Points(starGeometry, starMaterial);
      scene.add(stars);
[source: 310] // Planet Meshes and Orbits
      const planetMeshes = [];
[source: 311] planetsData.forEach((planet) => {
        const geometry = new THREE.SphereGeometry(planet.radius, 64, 64); // Increased segments
        const material = new THREE.MeshStandardMaterial({
          color: 0xffffff,
          emissive: planet.id === 0 ? 0xffff00 : 0x000000, // Sun ID is 0
          emissiveIntensity: planet.id === 0 ? 1.8 : 0, // Slightly stronger emission
          map: null // Initialize map as null
        });

        // Store texture paths in userData for later switching
        mesh.userData.texturePath = `textures/${planet.texture}`;
        if (planet.texture_high) {
            mesh.userData.textureHighPath = `textures/${planet.texture_high}`;
        }
        mesh.userData.isHighRes = false; // Track current texture state

       
[source: 312]  // Load initial low-res texture
        loadTexture(mesh, mesh.userData.texturePath, false); // Use the new function

        const mesh = new THREE.Mesh(geometry, material);
[source: 314] mesh.position.x = planet.distance;
        mesh.rotation.x = (planet.tilt * Math.PI) / 180;
        mesh.userData.id = planet.id;
[source: 315] scene.add(mesh);

[source: 316] // Create Orbit Paths
        if (planet.distance > 0) {
          const points = [];
[source: 317] const segments = 128;
          for (let i = 0; i <= segments; i++) {
              const theta = (i / segments) * Math.PI * 2;
[source: 318] points.push(new THREE.Vector3(Math.cos(theta) * planet.distance, 0, Math.sin(theta) * planet.distance));
          }
          const orbitGeometry = new THREE.BufferGeometry().setFromPoints(points);
[source: 319] const colorMap = {
              1: 0xaaaaaa, // Mercury
              2: 0xffcc99, // Venus
              3: 0x3399ff, // Earth
              4: 0xff3333, // Mars
              5: 0xffaa33, // Jupiter
            
[source: 320]   6: 0xffdd77, // Saturn
              7: 0x66ccff, // Uranus
              8: 0x3366cc, // Neptune
          };
[source: 321] const orbitMaterial = new THREE.LineBasicMaterial({
            color: colorMap[planet.id] || 0xffffff,
            transparent: true,
            opacity: 0.4, // More subtle orbits
          });
[source: 322] const orbit = new THREE.Line(orbitGeometry, orbitMaterial);
          scene.add(orbit);
        }

         // --- Add Saturn's Rings ---
         if (planet.id === 6) { // Saturn's ID
            const ringTexture = loader.load("textures/saturn_ring.png");
[source: 323] const innerRadius = planet.radius * 1.2;
            const outerRadius = planet.radius * 2.2;
            const ringGeometry = new THREE.RingGeometry(innerRadius, outerRadius, 64);
[source: 324] // Correct UV mapping for ring texture
            var pos = ringGeometry.attributes.position;
[source: 325] var v3 = new THREE.Vector3();
            for (let i = 0; i < pos.count; i++){
                v3.fromBufferAttribute(pos, i);
[source: 326] ringGeometry.attributes.uv.setXY(i, v3.length() < innerRadius + 0.1 ? 0 : 1, 1);
[source: 327] }

            const ringMaterial = new THREE.MeshBasicMaterial({ // Use MeshBasicMaterial for rings
                map: ringTexture,
                color: 0xffffff, // Adjust tint if needed
                side: THREE.DoubleSide,
                transparent: true,
      
[source: 328]           opacity: 0.8 // Adjust opacity
            });
[source: 329] const rings = new THREE.Mesh(ringGeometry, ringMaterial);
            rings.rotation.x = Math.PI / 2;
[source: 330] // Rotate rings to align horizontally
            mesh.add(rings);
[source: 331] // Add rings as child of Saturn mesh
         }

          // Add Jupiter's Great Red Spot (simplified) - Added back
          if (planet.id === 5) { // Jupiter's ID
              const spotGeometry = new THREE.SphereGeometry(planet.radius * 0.2, 16, 16);
[source: 332] // Relative size
              const spotMaterial = new THREE.MeshBasicMaterial({ color: 0xbb5533, transparent: true, opacity: 0.8 });
[source: 333] const redSpot = new THREE.Mesh(spotGeometry, spotMaterial);
              // Position roughly on the surface equatorially
              redSpot.position.set(0, planet.radius * 0.5, planet.radius * 0.85);
[source: 334] // Adjust Y and Z
              mesh.add(redSpot);
[source: 335] // Add spot as child of Jupiter mesh
          }


        planetMeshes.push({ mesh, planetData: planet, angle: Math.random() * Math.PI * 2 });
[source: 336] // Randomize start angle
      });
[source: 337] // --- Asteroid Belt ---
      const asteroidGeometry = new THREE.BufferGeometry();
      const asteroidCount = 1500;
[source: 338] // More asteroids
      const asteroidPos = new Float32Array(asteroidCount * 3);
[source: 339] const marsOrbit = planetsData.find(p => p.id === 4).distance;
      const jupiterOrbit = planetsData.find(p => p.id === 5).distance;
[source: 340] const beltInnerRadius = marsOrbit + 3;
      const beltOuterRadius = jupiterOrbit - 5;
      const beltWidth = beltOuterRadius - beltInnerRadius;
[source: 341] for (let i = 0; i < asteroidCount; i++) {
        const angle = Math.random() * Math.PI * 2;
[source: 342] const radius = beltInnerRadius + Math.random() * beltWidth;
        asteroidPos[i * 3] = Math.cos(angle) * radius;
[source: 343] asteroidPos[i * 3 + 1] = (Math.random() - 0.5) * 1.0;
[source: 344] // Slightly wider vertical spread
        asteroidPos[i * 3 + 2] = Math.sin(angle) * radius;
[source: 345] }
      asteroidGeometry.setAttribute('position', new THREE.BufferAttribute(asteroidPos, 3));
      const asteroidMaterial = new THREE.PointsMaterial({ color: 0xaaaaaa, size: 0.08 });
[source: 346] // Slightly larger
      const asteroids = new THREE.Points(asteroidGeometry, asteroidMaterial);
      scene.add(asteroids);
[source: 347] // --- Comet --- (Simplified for orbit)
      const cometGeometry = new THREE.SphereGeometry(0.2, 16, 16);
[source: 348] const cometMaterial = new THREE.MeshBasicMaterial({ color: 0xaaddff });
      const comet = new THREE.Mesh(cometGeometry, cometMaterial);
      scene.add(comet);
[source: 349] // Simple tail (using a Line)
      const tailPoints = [new THREE.Vector3(0, 0, 0), new THREE.Vector3(0, 0, -2)];
[source: 350] // Tail extends behind
      const tailGeometry = new THREE.BufferGeometry().setFromPoints(tailPoints);
[source: 351] const tailMaterial = new THREE.LineBasicMaterial({ color: 0xaaddff, transparent: true, opacity: 0.6, linewidth: 2 });
      const tail = new THREE.Line(tailGeometry, tailMaterial);
[source: 352] comet.add(tail); // Add tail to comet mesh


      // --- Dust Particles --- (Less dense)
      const dustGeometry = new THREE.BufferGeometry();
[source: 353] const dustCount = 1000;
      const dustPos = new Float32Array(dustCount * 3);
[source: 354] for (let i = 0; i < dustCount; i++) {
        dustPos[i * 3] = (Math.random() - 0.5) * 200;
[source: 355] // Reduced range
        dustPos[i * 3 + 1] = (Math.random() - 0.5) * 200;
[source: 356] dustPos[i * 3 + 2] = (Math.random() - 0.5) * 200;
[source: 357] }
      dustGeometry.setAttribute('position', new THREE.BufferAttribute(dustPos, 3));
[source: 358] const dustMaterial = new THREE.PointsMaterial({
        color: 0x777777, size: 0.05, transparent: true, opacity: 0.4, // More transparent
      });
[source: 359] const dust = new THREE.Points(dustGeometry, dustMaterial);
      scene.add(dust);

      // --- DOM Elements ---
      const infoPanel = document.getElementById("infoPanel");
[source: 360] const planetNameEl = document.getElementById("planetName");
      const planetInfoEl = document.getElementById("planetInfo");
      const planetFactEl = document.getElementById("planetFact");
[source: 361] // Fact element
      const closeBtn = document.getElementById("closeBtn");
      const planetsMenu = document.getElementById("planetsMenu");
      const planetsDropdown = document.getElementById("planetsDropdown");
[source: 362] const langToggleBtn = document.getElementById("langToggleBtn");
      const bodyEl = document.body;

      // --- Raycasting ---
      const raycaster = new THREE.Raycaster();
[source: 363] const mouse = new THREE.Vector2();

      // --- Event Listeners ---
      window.addEventListener("click", (event) => {
        // Prevent clicks on menu/infopanel from triggering raycast
        if (event.target.closest('#menuBar') || event.target.closest('#infoPanel')) {
             return;
        }

        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
  
[source: 364]       raycaster.setFromCamera(mouse, camera);

        const intersects = raycaster.intersectObjects(planetMeshes.map((p) => p.mesh));

        if (intersects.length > 0) {
          const clickedPlanetMesh = intersects[0].object;
          const planetId = clickedPlanetMesh.userData.id;
          // *** Instead of just displaying info, focus on the clicked planet ***
          focusOnPlanet(planetId);
        } else {
            // Optional: Hide info panel if clicking empty space
            // infoPanel.style.display = 'none';
            // Reset focus if clicking space? Maybe not desirable.
[source: 366] }
      });

      closeBtn.addEventListener("click", () => {
        infoPanel.style.display = "none";
        // Don't automatically stop following, let user interaction handle it
        // isFollowingPlanet = false;
        // focusedPlanetIndex = -1;
      });
[source: 367] planetsMenu.addEventListener("click", (e) => {
        e.stopPropagation(); // Prevent document click handler
        planetsDropdown.classList.toggle("show");
      });
[source: 368] // Close dropdown if clicking outside
      document.addEventListener("click", (e) => {
          if (!planetsMenu.contains(e.target)) {
              planetsDropdown.classList.remove('show');
          }
      });
[source: 369] langToggleBtn.addEventListener("click", () => {
          currentLanguage = currentLanguage === 'ar' ? 'en' : 'ar';
          updateLanguageUI();
          // If info panel is open, update its content immediately
          if (infoPanel.style.display === 'block' && focusedPlanetIndex !== -1) {
               const currentPlanetData = planetsData[focusedPlanetIndex];
              
[source: 370]  displayPlanetInfo(currentPlanetData);
          } else if (infoPanel.style.display === 'block') {
              // Find which planet info is displayed if not following (rare case)
               const displayedName = planetNameEl.textContent;
               const currentPlanetData = planetsData.find(p => p.name[currentLanguage === 'ar' ? 'en' : 'ar'] === displayedName); // Check against the *other* lang
      
[source: 371]          if (currentPlanetData) displayPlanetInfo(currentPlanetData);
          }
      });
[source: 372] // --- Functions ---

      function displayPlanetInfo(planetData) {
         planetNameEl.textContent = planetData.name[currentLanguage];
[source: 373] planetInfoEl.innerHTML = planetData.info[currentLanguage].replace(/\n/g, "<br>");
         planetFactEl.textContent = planetData.fact[currentLanguage]; // Display fact
         infoPanel.style.display = "block";
[source: 374] }


      function updateLanguageUI() {
          // Update body direction
          bodyEl.dir = currentLanguage === 'ar' ? 'rtl' : 'ltr'; [cite: 375]

          // Update menu text
          planetsMenu.firstChild.textContent = uiText.planetsMenu[currentLanguage].trim(); [cite: 376]
          langToggleBtn.textContent = uiText.langToggle[currentLanguage]; [cite: 377]
          planetsDropdown.innerHTML = ''; [cite: 378]
          planetsData.forEach((planet) => {
              const item = document.createElement("a");
              item.href = "#";
              item.classList.add("dropdown-item");
              item.setAttribute("data-planet-id", planet.id);
              item.textContent = planet.name[currentLanguage];
       
[source: 379]        item.addEventListener("click", (e) => {
                  e.preventDefault();
                  e.stopPropagation(); // Prevent closing dropdown immediately
                  const planetId = parseInt(item.getAttribute("data-planet-id"));
                  focusOnPlanet(planetId);
          
[source: 380]         planetsDropdown.classList.remove("show");
              });
              planetsDropdown.appendChild(item);
          });
[source: 381] infoPanel.style.textAlign = currentLanguage === 'ar' ? 'right' : 'left'; [cite: 382]
      }

      // *** NEW: Texture Loading Function with Caching ***
      function loadTexture(mesh, texturePath, isHighResAttempt) {
          const cachedTexture = textureCache[texturePath];
          if (cachedTexture) {
              // Apply cached texture
              applyTexture(mesh, cachedTexture, isHighResAttempt);
              return; // Don't load again
          }

          // Load new texture
          loader.load(
              texturePath,
              (texture) => {
                  textureCache[texturePath] = texture; // Cache it
                  applyTexture(mesh, texture, isHighResAttempt);
              },
              undefined,
              (err) => {
                  console.error(`Error loading texture: ${texturePath}`, err);
                  // If high-res fails, try loading low-res as fallback
                  if (isHighResAttempt && mesh.userData.texturePath) {
                      console.log(`Falling back to low-res texture: ${mesh.userData.texturePath}`);
                      loadTexture(mesh, mesh.userData.texturePath, false);
                  }
              }
          );
      }

      // *** NEW: Apply Texture Function ***
      function applyTexture(mesh, texture, isHighRes) {
           if (!mesh || !mesh.material) return; // Safety check

           mesh.material.map = texture;
           mesh.userData.isHighRes = isHighRes; // Update state

            // Special handling for Sun's emissive map
            if (mesh.userData.id === 0) {
                mesh.material.emissiveMap = texture;
                mesh.material.emissive = new THREE.Color(0xffffaa);
                mesh.material.emissiveIntensity = 1.2;
            } else {
                // Ensure non-suns don't glow if switching textures
                 mesh.material.emissiveMap = null;
                 mesh.material.emissive = new THREE.Color(0x000000);
                 mesh.material.emissiveIntensity = 0;
            }
           mesh.material.needsUpdate = true;
      }

      function focusOnPlanet(planetId) {
          const planetIndex = planetsData.findIndex(p => p.id === planetId); [cite: 383]
          if (planetIndex === -1) return;

          const targetPlanet = planetMeshes[planetIndex];
          const targetData = targetPlanet.planetData;

          if (followAnimationId) cancelAnimationFrame(followAnimationId); [cite: 384]

          focusedPlanetIndex = planetIndex;
          infoPanel.style.display = 'none'; [cite: 385]

          const startPosition = camera.position.clone(); [cite: 386]
          const startTarget = controls.target.clone();
          const endTarget = targetPlanet.mesh.position.clone(); [cite: 387]

          // Calculate end position: behind the planet, scaled by radius
          const offsetDistance = targetData.radius * (targetData.id === 0 ? 5 : 4); // *** Slightly closer default view ***
[source: 388] const direction = new THREE.Vector3(0, 0.1, 1); // *** Lower angle view ***
[source: 389] direction.applyQuaternion(targetPlanet.mesh.quaternion); [cite: 390]
          direction.normalize(); [cite: 391]
          const endPosition = endTarget.clone().add(direction.multiplyScalar(offsetDistance));


          const duration = 1000; // ms *** Faster transition ***
          const startTime = Date.now(); [cite: 392]
          function animateCameraFocus() {
              const elapsed = Date.now() - startTime; [cite: 393]
              const progress = Math.min(elapsed / duration, 1);
              const easeProgress = 0.5 * (1 - Math.cos(Math.PI * progress)); [cite: 394]

              camera.position.lerpVectors(startPosition, endPosition, easeProgress); [cite: 395]
              controls.target.lerpVectors(startTarget, endTarget, easeProgress);
              controls.update(); [cite: 396]

              if (progress < 1) {
                  followAnimationId = requestAnimationFrame(animateCameraFocus); [cite: 397]
              } else {
                  followAnimationId = null;
[source: 398] isFollowingPlanet = true; // Start following *after* animation
                  controls.target.copy(endTarget); [cite: 399]
                  camera.position.copy(endPosition); [cite: 400]
                  controls.update(); [cite: 401]
                  displayPlanetInfo(targetData); // Show info panel *after* arriving
                  lastManualControlTime = 0; // Reset manual control timer
                  // *** Trigger initial texture check after focusing ***
                  checkAndSwitchTexture(targetPlanet.mesh, targetData);
              }
          }

          animateCameraFocus(); [cite: 402]
      }

      // *** NEW: Function to Check Distance and Switch Texture ***
      function checkAndSwitchTexture(mesh, planetData) {
          if (!mesh || !planetData) return;

          const distanceToPlanet = camera.position.distanceTo(mesh.position);
          const radiusThreshold = planetData.radius * highResDistanceThreshold;

          const needsHighRes = distanceToPlanet < radiusThreshold;
          const hasHighResTexture = !!mesh.userData.textureHighPath; // Check if high-res exists

          if (needsHighRes && hasHighResTexture && !mesh.userData.isHighRes) {
              // Switch to High-Res
              console.log(`Switching to HIGH res for ${planetData.name.en}`);
              loadTexture(mesh, mesh.userData.textureHighPath, true);
          } else if (!needsHighRes && mesh.userData.isHighRes) {
              // Switch back to Low-Res
              console.log(`Switching to LOW res for ${planetData.name.en}`);
              loadTexture(mesh, mesh.userData.texturePath, false);
          }
          // Otherwise, stay with the current texture
      }


      // --- Animation Loop ---
      function animate() {
        requestAnimationFrame(animate); [cite: 403]
        const time = Date.now(); // Use time for smooth updates

        planetMeshes.forEach((p, index) => {
          const { mesh, planetData } = p;
          // Planet Rotation
          mesh.rotation.y += planetData.rotation * 0.1;

          // Planet Orbit
          if (planetData.distance > 0) {
            
[source: 404]         p.angle += planetData.speed * 0.5;
            mesh.position.x = Math.cos(p.angle) * planetData.distance;
            mesh.position.z = Math.sin(p.angle) * planetData.distance;
          }

          // Make Jupiter's Red Spot rotate with Jupiter [cite: 405, 406, 407]
          // Make Saturn's rings rotate with Saturn [cite: 408]
          // (These are handled automatically as children of the planet mesh)


          // *** MODIFIED Camera Following Logic ***
          if (isFollowingPlanet && index === focusedPlanetIndex) {
            const currentTargetPosition = mesh.position.clone(); [cite: 409]

            // --- Update Target ---
            // Smoothly update the control's target to the planet's current position
            controls.target.lerp(currentTargetPosition, 0.1); // Adjust lerp factor for smoothness


            // --- Camera Position (Only if NOT manually controlled recently) ---
            // We let OrbitControls handle the camera position based on user input (zoom/rotate)
            // relative to the 'controls.target'. We don't force camera.position here anymore
            // unless we explicitly want to reset the view or override user input.

            // *** Trigger Texture Check during follow ***
             checkAndSwitchTexture(mesh, planetData);

          } else if (index === focusedPlanetIndex && !isFollowingPlanet) {
               // *** Trigger Texture Check even if not actively following (manual control) ***
               checkAndSwitchTexture(mesh, planetData);
          } else if (index !== focusedPlanetIndex && mesh.userData.isHighRes) {
               // *** Ensure non-focused planets revert to low-res ***
                console.log(`Switching non-focused ${planetData.name.en} back to LOW res`);
                loadTexture(mesh, mesh.userData.texturePath, false);
          }
        });
[source: 414] // Comet Animation
         const cometTime = time * 0.0002; [cite: 415]
         const cometSemiMajor = 80;
         const cometSemiMinor = 50;
         comet.position.x = Math.cos(cometTime) * cometSemiMajor;
         comet.position.z = Math.sin(cometTime) * cometSemiMinor;
[source: 416] comet.position.y = Math.sin(cometTime * 0.7) * 15;
         const dirToSun = comet.position.clone().normalize().negate(); [cite: 417]
         comet.lookAt(comet.position.clone().add(dirToSun));


        controls.update(); // *** CRITICAL: Update controls in the loop *** [cite: 418]
        renderer.render(scene, camera); [cite: 419]
      }

      // --- Initial Setup ---
      updateLanguageUI(); [cite: 420]
      animate(); [cite: 421]
      // --- Resize Listener ---
      window.addEventListener("resize", () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }); [cite: 422]
    </script>
  </body>
</html>
